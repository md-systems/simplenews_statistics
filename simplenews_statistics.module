<?php

/**
 * @file
 * Main simplenews statistics file.
 */

/**
 * @todo: Find a way to use simplenews' message caching (token replacement).
 */

/**
 * Implements hook_menu().
 */
function simplenews_statistics_menu() {
  $items['admin/config/services/simplenews/statistics'] = array(
    'title' => 'Statistics',
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('simplenews_statistics_admin_settings_form'),
    'access arguments' => array('administer newsletter statistics'),
    'file' => 'simplenews_statistics.admin.inc',
  );
  $items['admin/config/services/simplenews/statistics/settings'] = array(
    'title' => 'Settings',
    'weight' => -15,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['track/open/%/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'simplenews_statistics_open',
    'page arguments' => array(2, 3),
    'access arguments' => array('access content'),
  );
  $items['track/click/%'] = array(
    'type' => MENU_CALLBACK,
    'page callback' => 'simplenews_statistics_click',
    'page arguments' => array(2),
    'access arguments' => array('access content'),
  );

  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function simplenews_statistics_menu_alter(&$items) {
  // Set a custom access callback function for our view page display path.
  $items['node/%/simplenews_statistics']['access callback'] = 'simplenews_statistics_menu_tab_access_callback';
}

/**
 * A custom 'access callback' function used by our view page display
 * to determine if its local task menu tab should be shown or not.
 */
function simplenews_statistics_menu_tab_access_callback($options = array()) {
  // Grab the default access callback function name, prepare the access
  // arguments, then see what the default access call back result is
  // according to views.
  $access_callback = $options[0];
  $access_arguments = $options[1];
  $access = call_user_func_array($access_callback, $access_arguments);

  if (!$access) {
    // The default access callback is false, so the user is not allowed access.
    return FALSE;
  }

  // Show tab only if the node type is 'simplenews'.
  $node = node_load(arg(1));
  if ($node && $node->type == 'simplenews') {
    return TRUE;
  }
  else {
    return FALSE;
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function simplenews_statistics_module_implements_alter(&$implementations, $hook) {
  // When the implementations of hook_menu_alter are called, we need our module
  // to be called after views, so let's remove it from the implementations then
  // add it to the end.
  if ($hook == 'menu_alter') {
    if (isset($implementations['simplenews_statistics'])) {
      unset($implementations['simplenews_statistics']);
      $implementations['simplenews_statistics'] = FALSE;
    }
  }
}

/**
 * Implements hook_permission().
 */
function simplenews_statistics_permission() {
  $perms = array(
    'administer newsletter statistics' => array(
      'title' => t('Administer newsletter statistics'),
      'description' => t('Allows user to administer newsletter statistics.'),
    ),
    'view newsletters statistics' => array(
      'title' => t('View newsletter statistics'),
      'description' => t('Allows user to access the statistics.'),
    ),
  );
  return $perms;
}

/**
 * Access for newsletter statistics.
 */
function simplenews_statistics_access($node = NULL) {
  // If the user has the global permission, allow access.
  if (user_access('view newsletters statistics')) {
    return TRUE;
  }

  return FALSE;
}

/**
 * Implements hook_node_delete().
 */
function simplenews_statistics_node_delete($node) {
  if ($node->type == 'simplenews') {
    // Delete all click and open records for this newsletter.
    $url_query = db_select('simplenews_statistics_url', 'ssu')
      ->fields('ssu', array('urlid'))
      ->condition('ssu.nid', $node->nid);
    $result = $url_query->execute();

    $urlids = array();
    foreach ($result as $url_record) {
      $urlids[] = $url_record->urlid;
    }

    db_delete('simplenews_statistics_click')
      ->condition('urlid', $urlids)
      ->execute();
    db_delete('simplenews_statistics_open')
      ->condition('nid', $node->nid)
      ->execute();
    // Keep the URL records so links in the newsletter will still be clickable.
    // @todo Delete clicks and opens per subscriber when they are deleted.
  }
}

/**
 * Check and log the opens.
 */
function simplenews_statistics_open($nid, $snid, $return = FALSE) {
  // Call possible decoders for the snid in modules implementing the hook.
  // Modules implementing this hook should validate this input themself because
  // we can not know what kind of string they will generate.
  $hook = 'simplenews_statistics_decode_snid';
  foreach (module_implements($hook) as $module) {
    $function = $module . '_' . $hook;
    if (function_exists($function)) {
      $snid = $function($snid);
    }
  }

  // Once decoded properly we can know for sure that the $snid is numeric.
  if (!is_numeric($snid)) {
    watchdog('simplenews_statistics', 'Simplenews statistics open called with illegal parameter.');
  }
  else {
    $subscriber = simplenews_subscriber_load($snid);
    if (!empty($subscriber) && $subscriber->snid === $snid) {
      $record = new stdClass();
      $record->snid = $subscriber->snid;
      $record->nid = $nid;
      $record->timestamp = time();
      drupal_write_record('simplenews_statistics_open', $record);
    }
  }

  if ($return) {
    // Return to simplenews_statistics_click()
    return;
  }
  else {
    // Render a transparent image and stop PHP execution.
    $type = 'image/png; utf-8';
    $file = drupal_get_path('module', 'simplenews_statistics') . '/images/count.png';

    // @todo: Set some more headers like cache.
    drupal_add_http_header('Content-Type', $type);
    drupal_add_http_header('Content-Length', filesize($file));

    readfile($file);
    drupal_exit();
  }
}

/**
 * Check and log the clicks.
 */
function simplenews_statistics_click($urlid) {
  // Call possible decoders for the urlid in modules implementing the hook.
  $hook = 'simplenews_statistics_decode_urlid';
  foreach (module_implements($hook) as $module) {
    $function = $module . '_' . $hook;
    if (function_exists($function)) {
      $urlid = $function($urlid);
    }
  }

 // Once decoded properly we can know for sure that the $snid and $urlid are
  // numeric. Fallback on any error is to go to the homepage.
  if (!is_numeric($urlid)) {
    watchdog('simplenews_statistics', 'Simplenews statistics click called with illegal parameter.');
    drupal_goto();
  }

  // Track click if there is an url and a valid subscriber. For test mails the
  // snid will be 0, so no valid subscriber will be loaded and the click won't
  // be counted. But the clicked link will still redirect properly.
  $query = db_select('simplenews_statistics_url', 'ssu')
    ->fields('ssu')
    ->condition('urlid', $urlid);
  $url_record = $query->execute()->fetchObject();

  $snid = $url_record->snid;
  $nid = $url_record->nid;

  $subscriber = simplenews_subscriber_load($snid);
  if ($url_record) {
    $click_record = new stdClass();
    $click_record->urlid = $urlid;
    $click_record->timestamp = time();
    drupal_write_record('simplenews_statistics_click', $click_record);

    // Check if the open action was registered for this subscriber. If not we
    // can track the open here to improve statistics accuracy.
    $query = db_select('simplenews_statistics_open', 'sso');
    $query->condition('snid', $snid);
    $num_rows = $query->countQuery()->execute()->fetchField();
    if ($num_rows == 0) {
      simplenews_statistics_open($nid, $snid, TRUE);
    }
  }

  // Redirect to the right URL.
  if (!empty($url_record) && !empty($url_record->url)) {
    // Split the URL into it's parts for easier handling.
    $path = $url_record->url;
    $options = array(
      'fragment' => '',
      'query' => array(),
    );

    // The fragment should always be after the query, so we get that first.
    // We format it for the options array for drupal_goto().
    $fragment_position = strpos($path, '#');
    if (FALSE !== $fragment_position) {
      $fragment = substr($path, $fragment_position + 1);
      $path = str_replace('#' . $fragment, '', $path);
      $options['fragment'] = $fragment;
    }
    // Determine the position of the query string, get it, delete it from the
    // original path and then we explode the parts and the key-value pairs to
    // get a clean output that we can use in drupal_goto().
    $query_position = strpos($path, '?');
    if (FALSE !== $query_position) {
      $query = substr($path, $query_position + 1);
      $path = str_replace('?' . $query, '', $path);
      $element = explode('&', $query);
      foreach ($element as $pair) {
        $pair = explode('=', $pair);
        if (!isset($pair[1])) {
          $pair[1] = '';
        }
        $options['query'][$pair[0]] = $pair[1];
      }
    }

    // Call possible rewriters for the url.
    $hook = 'simplenews_statistics_rewrite_goto_url';
    foreach (module_implements($hook) as $module) {
      $function = $module . '_' . $hook;
      if (function_exists($function)) {
        $function($path, $options, $snid, $nid);
      }
    }
    // Fragment behaviour can get out of spec here.
    drupal_goto($path, $options);
  }

  // Fallback on any error is to go to the homepage.
  drupal_goto();
}

/**
 * Implements hook_mail_alter().
 *
 * Parses all the links in the email so they can be tracked. Also adds a hidden
 * image to the body to track opens.
 */
function simplenews_statistics_mail_alter(&$message) {
  if (($message['id'] == 'simplenews_node' || $message['id'] == 'simplenews_test')) {
    $node = $message['params']['simplenews_source']->getNode();
    $subscriber = $message['params']['simplenews_source']->getSubscriber();

    // During testing the snid might be unset. Use 0 in that case. This will
    // make sure that the link will still work but won't be counted.
    $snid = isset($subscriber->snid) ? $subscriber->snid : 0;

    // Parse body.
    _simplenews_statistics_parse_links($message['body'], $node->nid, $snid);

    // Add view image.
    _simplenews_statistics_image_tag($message['body'], $node->nid, $snid);
  }
}

/**
 * Helper function to parse links in the body.
 */
function _simplenews_statistics_parse_links(&$body, $nid, $snid) {
  if (is_array($body)) {
    foreach ($body as $key => $element) {
      _simplenews_statistics_parse_links($body[$key], $nid, $snid);
    }
  }
  else {
    // @todo: Try and write some cleaner code here.
    $body = preg_replace_callback(
      '/(<a[^>]+href=")([^"]*)/mi',
      function($matches) use ($nid, $snid) {
        $value = _simplenews_statistics_replace_url($matches[2], $nid, $snid);
        return '<a href="' . $value;
      },
      $body
    );
  }
}

/**
 * Add hidden image for open statistics.
 */
function _simplenews_statistics_image_tag(&$body, $nid, $snid) {
  // @todo: Figure out why this construction was ever made.
  if (is_array($body)) {
    foreach ($body as $key => $element) {
      _simplenews_statistics_image_tag($body[$key], $nid, $snid);
      return;
    }
  }
  else {
    // Call possible encoders for the snid in modules implementing the hook.
    $hook = 'simplenews_statistics_encode_snid';
    foreach (module_implements($hook) as $module) {
      $function = $module . '_' . $hook;
      if (function_exists($function)) {
        $snid = $function($snid);
      }
    }
    $body .= '<img src="' . url('track/open/' . $nid . '/' . $snid, array('absolute' => TRUE)) . '" width="1" height="1" style="display: none;" />';
  }
}

/**
 * Gets an url record.
 *
 * The caching causes a slight performance hit on our main task: redirecting
 * users. But whilst generating/sending mails it gives us a huge performance
 * gain though!
 *
 * @param string $url
 *   Complete url to search for.
 * @param bool $reset
 *   (optional) Reset cache for this URL.
 *
 * @return object || FALSE
 *   Object representing the url record or FALSE.
 */
function simplenews_statistics_get_url($url, $reset = FALSE) {
  // We don't use the magic __FUNCTION__ as parameter because we want to use the
  // static cache outside the scope of this function as well. Mainly in the
  // simplenews_statistics_set_url() function.
  $cached_urls = &drupal_static('simplenews_statistics_url');

  if (!isset($cached_urls[$url]) || $reset) {
    $query = db_select('simplenews_statistics_url', 'ssu');
    $query->fields('ssu', array('urlid'));
    $query->condition('url', $url);
    $record = $query->execute()->fetchObject();
    if ($record !== FALSE) {
      $cached_urls[$url] = $record;
      return $record;
    }
  }
  return FALSE;
}

/**
 * Creates an url record in the database.
 *
 * @param string $url
 *   The URL.
 * @param int $nid
 *   The Simplenews nid this link belongs to.
 * @return object || FALSE
 *   Object representing the url record or FALSE.
 */
function simplenews_statistics_set_url($url, $nid, $snid) {
  $record = new stdClass();
  $record->snid = $snid;
  $record->nid = $nid;
  $record->url = $url;

  $result = drupal_write_record('simplenews_statistics_url', $record);
  if ($result !== FALSE) {
    // Immediately cache the record for later use.
    $cached_urls = &drupal_static('simplenews_statistics_url');
    $cached_urls[$url] = $record;
    return $record;
  }
  return FALSE;
}

/**
 * Alter link to go through statistics.
 */
function _simplenews_statistics_replace_url($url, $nid, $snid) {
  // Do not replace anchor links.
  $fragment_position = substr($url, 0, 1);
  if ($fragment_position == '#') {
    return $url;
  }

  // Do not replace 'mailto:' links unless it is configured.
  $track_email_address = variable_get('simplenews_statistics_track_email_address', 1);
  if ($track_email_address == 0) {
    if (substr($url, 0, 7) == 'mailto:') {
      return $url;
    }
  }

  // Get the url record from the database. Uses Drupal's static caching if
  // available. Create a new record in database and cache if there isn't one.
  $url_record = simplenews_statistics_get_url($url);
  if (FALSE === $url_record) {
    $url_record = simplenews_statistics_set_url($url, $nid, $snid);
  }

  // Call possible encoders for the snid in modules implementing the hook.
  $hook = 'simplenews_statistics_encode_snid';
  foreach (module_implements($hook) as $module) {
    $function = $module . '_' . $hook;
    if (function_exists($function)) {
      $snid = $function($snid);
    }
  }

  // Call possible encoders for the urlid in modules implementing the hook.
  $hook = 'simplenews_statistics_encode_urlid';
  foreach (module_implements($hook) as $module) {
    $function = $module . '_' . $hook;
    if (function_exists($function)) {
      $url_record->urlid = $function($url_record->urlid);
    }
  }

  return url('track/click/' . $url_record->urlid, array('absolute' => TRUE));
}

/**
 * Implements hook_views_api().
 */
function simplenews_statistics_views_api() {
  return array(
    'api' => '3.0',
    'path' => drupal_get_path('module', 'simplenews_statistics') . '/includes/views',
  );
}
